---
phase: 01-aws-infrastructure
plan: 02
type: execute
wave: 2
depends_on:
  - 01-01
files_modified: []
autonomous: false
requirements:
  - INFRA-01
  - INFRA-02
  - INFRA-03
  - INFRA-04
  - INFRA-05

must_haves:
  truths:
    - "SSH into EC2 instance succeeds using the created key pair"
    - "docker compose version returns a v2.x.x version string on the instance"
    - "Root filesystem shows 30 GB or more of total disk space"
    - "curl to port 80 of the EC2 public hostname gets a TCP connection (even without an app running)"
    - "curl to port 8008 of the EC2 public hostname times out (port not in security group)"
  artifacts: []
  key_links:
    - from: "scripts/aws/instance-info.env"
      to: "EC2 instance via SSH"
      via: "PUBLIC_DNS and KEY_FILE values used to construct SSH command"
      pattern: "ssh -i.*ec2-user@"
---

<objective>
Verify all Phase 1 success criteria by SSHing into the EC2 instance and confirming Docker, Compose, disk, and security group rules work correctly.

Purpose: Prove the infrastructure is ready to receive the Docker Compose stack in Phase 2. Every success criterion from the roadmap must be verified before proceeding.

Output: Verified instance with confirmed Docker Compose v2, 30 GB disk, and correct security group rules.
</objective>

<execution_context>
@/Users/myownip/.config/claude/get-shit-done/workflows/execute-plan.md
@/Users/myownip/.config/claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-aws-infrastructure/01-RESEARCH.md
@.planning/phases/01-aws-infrastructure/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: SSH into instance and verify Docker, Compose, and disk</name>
  <files></files>
  <action>
Load instance metadata from Plan 01 output:
```bash
source scripts/aws/instance-info.env
```

**Step 1: Wait for cloud-init to complete**

SSH into the instance and wait for cloud-init. The instance is "running" but user-data may still be executing (takes 1-3 minutes on AL2023 with package installs).

```bash
ssh -o StrictHostKeyChecking=no -i "$KEY_FILE" ec2-user@"$PUBLIC_DNS" \
  "sudo cloud-init status --wait"
```

If cloud-init reports errors, check the log:
```bash
ssh -i "$KEY_FILE" ec2-user@"$PUBLIC_DNS" \
  "sudo tail -50 /var/log/cloud-init-output.log"
```

If cloud-init failed (Docker not installed), diagnose from the log and report the failure. Do NOT proceed with verification if cloud-init failed.

**Step 2: Verify Docker Engine is installed and running**
```bash
ssh -i "$KEY_FILE" ec2-user@"$PUBLIC_DNS" "docker --version"
```
Expected: `Docker version XX.XX.XX, build XXXXXXX`

Note: If "permission denied" error occurs, the docker group membership may not have taken effect. Try:
```bash
ssh -i "$KEY_FILE" ec2-user@"$PUBLIC_DNS" "newgrp docker && docker --version"
```
Or reconnect (new SSH session picks up group changes applied by cloud-init).

**Step 3: Verify Docker Compose v2 plugin**
```bash
ssh -i "$KEY_FILE" ec2-user@"$PUBLIC_DNS" "docker compose version"
```
Expected: `Docker Compose version v2.x.x` — the version MUST start with `v2`. If it returns an error or shows v1, the Compose binary install in user-data failed.

**Step 4: Verify disk size (INFRA-03)**
```bash
ssh -i "$KEY_FILE" ec2-user@"$PUBLIC_DNS" "df -h / | tail -1"
```
Expected: Size column shows `30G` or more. The device will show as `/dev/nvme0n1p1` (Nitro NVMe naming) — this is expected and correct despite the API using `/dev/xvda`.

**Step 5: Verify instance type (INFRA-01)**
```bash
ssh -i "$KEY_FILE" ec2-user@"$PUBLIC_DNS" \
  "curl -s http://169.254.169.254/latest/meta-data/instance-type"
```
Expected: `t3.small`

Record all verification outputs for the summary.
  </action>
  <verify>
All four checks pass:
1. `docker compose version` outputs `Docker Compose version v2.x.x`
2. `df -h /` shows 30G+ total size
3. Instance metadata confirms `t3.small`
4. SSH connection succeeded (implicitly verifies INFRA-05 key pair)
  </verify>
  <done>Docker Compose v2 is installed and working, disk is 30 GB+, instance type is t3.small, SSH access works</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify security group rules from outside the instance</name>
  <files></files>
  <action>
Present the following verification steps to the user. This is a human-verify checkpoint.

**What was built:** EC2 instance provisioned with security group allowing port 80 (public) and port 22 (admin IP only). Port 8008 is intentionally NOT exposed — Synapse will be Docker-internal only, accessed via Nginx proxy on port 80. Task 1 already verified: SSH works (port 22), Docker Compose v2 installed, 30 GB disk.

**How to verify — run these commands from your LOCAL machine (not the EC2 instance):**

1. **Port 80 is open** (should connect, even if no server is listening yet):
   ```bash
   source scripts/aws/instance-info.env
   curl -v --connect-timeout 5 http://$PUBLIC_DNS 2>&1 | head -10
   ```
   Expected: Connection succeeds (you may get "Connection refused" if nothing is listening on 80 yet — that is OK; what matters is it does NOT say "Connection timed out"). If it times out, the security group rule is wrong.

2. **Port 8008 is NOT reachable** (must time out):
   ```bash
   curl -v --connect-timeout 5 http://$PUBLIC_DNS:8008 2>&1 | head -5
   ```
   Expected: "Connection timed out" after 5 seconds. If it connects or refuses, port 8008 is exposed and the security group is wrong.

3. **Confirm security group rules via AWS CLI:**
   ```bash
   aws ec2 describe-security-groups --region "$REGION" --group-ids "$SG_ID" \
     --query "SecurityGroups[0].IpPermissions[*].{Port:FromPort,CIDR:IpRanges[0].CidrIp}" \
     --output table
   ```
   Expected: Exactly 2 rows — port 22 with your IP/32, port 80 with 0.0.0.0/0.

**Resume signal:** Type "approved" if all checks pass, or describe any issues found.
  </action>
  <verify>User confirms: port 80 connects (or "connection refused" — not "timed out"), port 8008 times out, AWS CLI shows exactly 2 ingress rules</verify>
  <done>Human has verified security group rules are correct: port 80 public, port 22 admin-only, port 8008 blocked</done>
</task>

</tasks>

<verification>
Phase 1 complete verification (all four roadmap success criteria):
1. SSH access works from admin machine using created key pair — verified in Task 1
2. `docker compose version` returns v2.x.x — verified in Task 1
3. Security group: port 80 open (public), port 22 open (admin IP), port 8008 blocked — verified in Task 2
4. EBS gp3 30 GB root volume attached — verified in Task 1 via `df -h /`
</verification>

<success_criteria>
- SSH into EC2 instance succeeds without password (key-based auth)
- `docker compose version` returns `Docker Compose version v2.x.x`
- `df -h /` shows 30G+ total disk space on root filesystem
- `curl http://<PUBLIC_DNS>` connects (does not time out) — port 80 is open
- `curl http://<PUBLIC_DNS>:8008` times out — port 8008 is not exposed
- AWS CLI confirms exactly 2 security group ingress rules (port 22 admin-only, port 80 public)
</success_criteria>

<output>
After completion, create `.planning/phases/01-aws-infrastructure/01-02-SUMMARY.md`
</output>
