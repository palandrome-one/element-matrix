---
phase: 02-stack-configuration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - proxy/conf.d/element.conf
  - proxy/nginx.conf
  - compose/docker-compose.yml
autonomous: true
requirements:
  - STACK-01

must_haves:
  truths:
    - "Nginx config has a single HTTP :80 server block with no TLS directives"
    - "No 'return 301 https://' redirect exists in any server block"
    - "No HSTS header is sent (security-headers.conf not included)"
    - "Synapse proxy_pass has no trailing slash (http://synapse:8008; exactly)"
    - "Certbot service is removed from docker-compose.yml"
    - "Only port 80 is exposed by nginx in docker-compose.yml"
  artifacts:
    - path: "proxy/conf.d/element.conf"
      provides: "Single HTTP :80 server block with path-based routing to Element and Synapse"
      contains: "listen 80"
    - path: "proxy/nginx.conf"
      provides: "Base Nginx config without TLS params include"
    - path: "compose/docker-compose.yml"
      provides: "Docker Compose stack without certbot service, without 443/8448 ports"
  key_links:
    - from: "proxy/conf.d/element.conf"
      to: "synapse:8008"
      via: "proxy_pass directive"
      pattern: "proxy_pass http://synapse:8008;"
    - from: "proxy/conf.d/element.conf"
      to: "element:80"
      via: "proxy_pass directive"
      pattern: "proxy_pass http://element:80;"
    - from: "compose/docker-compose.yml"
      to: "proxy/conf.d/element.conf"
      via: "nginx volume mount"
      pattern: "../proxy/conf.d:/etc/nginx/conf.d:ro"
---

<objective>
Replace the production TLS/multi-domain Nginx config with an HTTP-only single-host reverse proxy, and strip all TLS/certbot infrastructure from the Docker Compose stack.

Purpose: The existing Nginx config assumes three separate domains with TLS certificates from Let's Encrypt. The POC runs on a single EC2 public hostname over HTTP. Without this change, Nginx will fail to start (missing cert files) and the entire stack will be down.

Output: HTTP-only element.conf, cleaned nginx.conf (no TLS include), docker-compose.yml with only port 80 and no certbot service.
</objective>

<execution_context>
@/Users/myownip/.config/claude/get-shit-done/workflows/execute-plan.md
@/Users/myownip/.config/claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-stack-configuration/02-RESEARCH.md
@proxy/conf.d/element.conf
@proxy/nginx.conf
@compose/docker-compose.yml
@proxy/snippets/security-headers.conf
@proxy/snippets/tls-params.conf
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace Nginx element.conf with HTTP-only single-host config and strip TLS from nginx.conf</name>
  <files>proxy/conf.d/element.conf, proxy/nginx.conf</files>
  <action>
**proxy/conf.d/element.conf** — Replace the ENTIRE file contents with a single HTTP :80 server block using path-based routing. The new content must be:

```nginx
# ──────────────────────────────────────────────
# HTTP-only reverse proxy — POC (no TLS)
# ──────────────────────────────────────────────
server {
    listen 80;
    listen [::]:80;
    server_name _;

    # Matrix API — route to Synapse (no trailing slash on proxy_pass!)
    location ~ ^(/_matrix|/_synapse/client) {
        proxy_pass http://synapse:8008;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        client_max_body_size 50m;
    }

    # Health check
    location /health {
        proxy_pass http://synapse:8008/health;
    }

    # .well-known for Matrix discovery
    location /.well-known/matrix/ {
        alias /var/www/well-known/matrix/;
        default_type application/json;
        add_header Access-Control-Allow-Origin "*" always;
    }

    # Element Web — catch-all
    location / {
        proxy_pass http://element:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

Key rules enforced:
- `server_name _;` — catch-all, matches any hostname (EC2 public hostname will vary)
- `proxy_pass http://synapse:8008;` — NO trailing slash (breaks Matrix signature verification per official Synapse reverse_proxy.md)
- No `ssl_certificate`, no `ssl_certificate_key`, no `include security-headers.conf`, no `return 301 https://`
- WebSocket headers preserved for Synapse sync endpoint
- `client_max_body_size 50m` on the Synapse location for file uploads
- `.well-known` served from static files with CORS header

**proxy/nginx.conf** — Remove the TLS params include line. Find and delete:
```
    # Include TLS params
    include /etc/nginx/snippets/tls-params.conf;
```
Leave all other content (worker_processes, events, gzip, server_tokens, mime types, access_log) unchanged. The TLS params file (tls-params.conf) stays on disk but is no longer included — Nginx would warn or fail with ssl_protocols directives in http{} context when no SSL listener exists.
  </action>
  <verify>
Verify with grep:
1. `grep -c "listen 80" proxy/conf.d/element.conf` — should return 2 (IPv4 + IPv6)
2. `grep -c "443\|8448\|ssl_certificate\|return 301 https\|security-headers" proxy/conf.d/element.conf` — should return 0
3. `grep -c "proxy_pass http://synapse:8008;" proxy/conf.d/element.conf` — should return 1 (no trailing slash)
4. `grep -c "tls-params" proxy/nginx.conf` — should return 0
5. `grep -c "server_tokens off" proxy/nginx.conf` — should return 1 (other config preserved)
  </verify>
  <done>
element.conf contains exactly one server block listening on port 80 only, with path-based routing to Synapse and Element, no TLS directives, no HSTS, no HTTPS redirect. nginx.conf no longer includes tls-params.conf. Both files are syntactically valid Nginx config (will be confirmed when stack starts in Phase 3).
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove certbot service and TLS ports from docker-compose.yml</name>
  <files>compose/docker-compose.yml</files>
  <action>
Edit `compose/docker-compose.yml` to make three changes:

1. **Nginx ports** — Remove the `443:443` and `8448:8448` port mappings. Only `"80:80"` should remain:
```yaml
    ports:
      - "80:80"
```

2. **Nginx volumes** — Remove the two certbot volume mounts from the nginx service. Remove these lines:
```yaml
      - certbot_conf:/etc/letsencrypt:ro
      - certbot_webroot:/var/www/certbot:ro
```
Keep all other nginx volume mounts (nginx.conf, conf.d, snippets, well-known).

3. **Certbot service** — Delete the entire certbot service block (the comment header, `certbot:`, `image:`, `volumes:`, `entrypoint:`, and `networks:` lines under it).

4. **Certbot volumes** — Remove `certbot_conf:` and `certbot_webroot:` from the top-level `volumes:` section. Keep `postgres_data:`, `synapse_data:`, `synapse_media:`.

Do NOT change any other services (postgres, synapse, element). Do NOT change networks. Do NOT change any environment variables or other volume mounts.
  </action>
  <verify>
1. `grep -c "443\|8448" compose/docker-compose.yml` — should return 0
2. `grep -c "certbot" compose/docker-compose.yml` — should return 0
3. `grep -c '"80:80"' compose/docker-compose.yml` — should return 1
4. `grep -c "postgres_data\|synapse_data\|synapse_media" compose/docker-compose.yml` — count should be >= 3 (volumes still present)
5. `grep -c "certbot_conf\|certbot_webroot" compose/docker-compose.yml` — should return 0
  </verify>
  <done>
docker-compose.yml exposes only port 80 on nginx, has no certbot service, has no certbot volumes. All other services (postgres, synapse, element) are unchanged. The compose file is ready for HTTP-only operation.
  </done>
</task>

</tasks>

<verification>
Combined verification for STACK-01:
1. `grep -rn "443\|8448\|ssl_certificate\|return 301 https\|Strict-Transport-Security\|tls-params" proxy/conf.d/element.conf proxy/nginx.conf` — zero matches
2. `grep -c "certbot" compose/docker-compose.yml` — zero matches
3. `grep "proxy_pass http://synapse:8008;" proxy/conf.d/element.conf` — exactly one match, no trailing slash
4. `grep "listen 80" proxy/conf.d/element.conf` — exactly two matches (IPv4 + IPv6)
5. All files parse correctly (validated when stack starts in Phase 3)
</verification>

<success_criteria>
- element.conf has a single `listen 80` server block — no TLS, no HSTS, no HTTPS redirect
- proxy_pass to Synapse has no trailing slash
- nginx.conf does not include tls-params.conf
- docker-compose.yml has no certbot service, no certbot volumes, only port 80 exposed
- STACK-01 requirement satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/02-stack-configuration/02-01-SUMMARY.md`
</output>
