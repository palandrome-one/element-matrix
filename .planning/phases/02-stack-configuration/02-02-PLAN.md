---
phase: 02-stack-configuration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - synapse/homeserver.yaml
  - element/config.json
  - well-known/matrix/client
  - well-known/matrix/server
autonomous: true
requirements:
  - STACK-02
  - STACK-03
  - STACK-04
  - STACK-05

must_haves:
  truths:
    - "homeserver.yaml server_name is set to a placeholder pattern (__EC2_HOSTNAME__) ready for operator substitution"
    - "homeserver.yaml public_baseurl uses http:// protocol with the same placeholder"
    - "homeserver.yaml enable_registration is true"
    - "homeserver.yaml registration_requires_token is true"
    - "homeserver.yaml email block is disabled (will not crash Synapse with placeholder SMTP values)"
    - "Element config.json base_url uses http:// with the same placeholder"
    - "Element config.json server_name matches homeserver.yaml server_name"
    - "well-known files reference the POC hostname with http:// protocol"
  artifacts:
    - path: "synapse/homeserver.yaml"
      provides: "Synapse config with POC hostname, HTTP baseurl, registration enabled"
      contains: "enable_registration: true"
    - path: "element/config.json"
      provides: "Element Web config pointing to HTTP homeserver"
    - path: "well-known/matrix/client"
      provides: "Matrix client discovery with HTTP base_url"
    - path: "well-known/matrix/server"
      provides: "Matrix server discovery with POC hostname"
  key_links:
    - from: "element/config.json"
      to: "synapse/homeserver.yaml"
      via: "base_url must match public_baseurl host"
      pattern: "__EC2_HOSTNAME__"
    - from: "element/config.json"
      to: "synapse/homeserver.yaml"
      via: "server_name must match"
      pattern: "__EC2_HOSTNAME__"
    - from: "well-known/matrix/client"
      to: "synapse/homeserver.yaml"
      via: "base_url must match public_baseurl"
      pattern: "__EC2_HOSTNAME__"
---

<objective>
Update Synapse homeserver.yaml, Element config.json, and well-known discovery files to use the EC2 public hostname over HTTP, enable invite-only registration, and disable the email block that would crash Synapse.

Purpose: These three config files currently reference `example.com` with HTTPS URLs. Without updating them, Synapse will advertise the wrong base URL, Element will try to connect to a non-existent `matrix.example.com`, and registration will be disabled. The email block has `__PLACEHOLDER__` SMTP values that will cause Synapse to error on startup or on first email trigger.

Output: All application configs aligned to `http://__EC2_HOSTNAME__/` with registration enabled and email disabled. The `__EC2_HOSTNAME__` placeholder will be substituted with the actual EC2 public hostname at deploy time (Phase 3) since the hostname is in a gitignored `instance-info.env` file.
</objective>

<execution_context>
@/Users/myownip/.config/claude/get-shit-done/workflows/execute-plan.md
@/Users/myownip/.config/claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-stack-configuration/02-RESEARCH.md
@synapse/homeserver.yaml
@element/config.json
@well-known/matrix/client
@well-known/matrix/server
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Synapse homeserver.yaml for HTTP POC with registration enabled</name>
  <files>synapse/homeserver.yaml</files>
  <action>
Make the following targeted edits to `synapse/homeserver.yaml`. Do NOT rewrite the entire file — edit only the specific values listed:

1. **server_name** — Change from `"example.com"` to `"__EC2_HOSTNAME__"`:
```yaml
server_name: "__EC2_HOSTNAME__"
```
This is the most consequential change. `server_name` is permanently baked into every Matrix user ID (`@user:server_name`) on first `docker compose up`. It cannot be changed later without dropping the database. For this POC, the EC2 public hostname is the intended value. The `__EC2_HOSTNAME__` placeholder will be replaced with the actual hostname (e.g., `ec2-1-2-3-4.compute-1.amazonaws.com`) at deploy time via sed or envsubst.

2. **public_baseurl** — Change from `"https://matrix.example.com/"` to `"http://__EC2_HOSTNAME__/"`:
```yaml
public_baseurl: "http://__EC2_HOSTNAME__/"
```
Note: trailing slash is the documented convention per Synapse docs. Protocol is `http://` (no TLS for POC).

3. **web_client_location** — Change from `"https://chat.example.com/"` to `"http://__EC2_HOSTNAME__/"`:
```yaml
web_client_location: "http://__EC2_HOSTNAME__/"
```

4. **enable_registration** — Change from `false` to `true`:
```yaml
enable_registration: true
```
`registration_requires_token: true` is already present and correct — do NOT change it. Together these two settings enable invite-only registration (users need a token from admin API to register).

5. **Email block** — Comment out the entire `email:` block to prevent Synapse from trying to use placeholder SMTP values. Replace:
```yaml
email:
  smtp_host: "__SMTP_HOST__"
  smtp_port: 587
  smtp_user: "__SMTP_USER__"
  smtp_pass: "__SMTP_PASSWORD__"
  require_transport_security: true
  notif_from: "%(app)s <noreply@example.com>"
  app_name: "YourBrand Chat"
  enable_notifs: true
  notif_for_new_users: true
```
With:
```yaml
# email:                              # Disabled for POC — no SMTP configured
#   smtp_host: "__SMTP_HOST__"
#   smtp_port: 587
#   smtp_user: "__SMTP_USER__"
#   smtp_pass: "__SMTP_PASSWORD__"
#   require_transport_security: true
#   notif_from: "%(app)s <noreply@example.com>"
#   app_name: "YourBrand Chat"
#   enable_notifs: true
#   notif_for_new_users: true
```

Do NOT change: listeners, database, logging, media, secrets placeholders (__POSTGRES_PASSWORD__, __REGISTRATION_SHARED_SECRET__, __MACAROON_SECRET_KEY__, __FORM_SECRET__), federation, rate limiting, room defaults, retention, TURN, trusted_key_servers, admin_contact, or server_notices.
  </action>
  <verify>
1. `grep 'server_name:' synapse/homeserver.yaml` — should show `server_name: "__EC2_HOSTNAME__"`
2. `grep 'public_baseurl:' synapse/homeserver.yaml` — should show `public_baseurl: "http://__EC2_HOSTNAME__/"`
3. `grep 'web_client_location:' synapse/homeserver.yaml` — should show `web_client_location: "http://__EC2_HOSTNAME__/"`
4. `grep 'enable_registration:' synapse/homeserver.yaml` — should show `enable_registration: true`
5. `grep 'registration_requires_token:' synapse/homeserver.yaml` — should show `registration_requires_token: true`
6. `grep -c '^email:' synapse/homeserver.yaml` — should return 0 (block is commented out)
7. `grep -c 'https://' synapse/homeserver.yaml` — should return 0 (no HTTPS references remain)
8. `grep -c '__POSTGRES_PASSWORD__' synapse/homeserver.yaml` — should return 1 (secret placeholder preserved, not part of this plan's scope)
  </verify>
  <done>
homeserver.yaml has server_name and public_baseurl set to __EC2_HOSTNAME__ with http:// protocol, enable_registration is true, registration_requires_token is true, email block is commented out. No HTTPS URLs remain in the file. Secret placeholders are preserved for Phase 3 substitution.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Element config.json and well-known files for HTTP POC</name>
  <files>element/config.json, well-known/matrix/client, well-known/matrix/server</files>
  <action>
**element/config.json** — Make the following edits:

1. `default_server_config.m.homeserver.base_url` — Change from `"https://matrix.example.com"` to `"http://__EC2_HOSTNAME__"` (no trailing slash per Element convention)

2. `default_server_config.m.homeserver.server_name` — Change from `"example.com"` to `"__EC2_HOSTNAME__"` (must match homeserver.yaml server_name exactly)

3. `permalink_prefix` — Change from `"https://chat.example.com"` to `"http://__EC2_HOSTNAME__"`

4. `terms_and_conditions_links` — Replace the array contents with an empty array `[]` (the URLs point to non-existent pages on example.com — broken links in the UI)

5. `embedded_pages` — Replace the object contents with empty strings:
```json
"embedded_pages": {
    "welcome_url": "",
    "home_url": ""
}
```
(Same reason — these URLs point to non-existent pages)

Do NOT change: brand, integrations, disable_custom_urls, disable_guests, default_theme, room_directory, setting_defaults (custom theme), features, map_style_url, default_country_code, show_labs_settings, default_federate, disable_login_language_selector, disable_3pid_login, m.identity_server.

**well-known/matrix/client** — Replace file contents with:
```json
{
    "m.homeserver": {
        "base_url": "http://__EC2_HOSTNAME__"
    },
    "m.identity_server": {
        "base_url": ""
    }
}
```

**well-known/matrix/server** — Replace file contents with:
```json
{
    "m.server": "__EC2_HOSTNAME__:80"
}
```
Note: port 80 is specified explicitly since the default for `.well-known` server discovery is 8448 (federation port). For the POC, all traffic goes through port 80.
  </action>
  <verify>
1. `python3 -c "import json; d=json.load(open('element/config.json')); print(d['default_server_config']['m.homeserver']['base_url'])"` — should print `http://__EC2_HOSTNAME__`
2. `python3 -c "import json; d=json.load(open('element/config.json')); print(d['default_server_config']['m.homeserver']['server_name'])"` — should print `__EC2_HOSTNAME__`
3. `python3 -c "import json; d=json.load(open('element/config.json')); print(d['permalink_prefix'])"` — should print `http://__EC2_HOSTNAME__`
4. `python3 -c "import json; d=json.load(open('element/config.json')); print(d['terms_and_conditions_links'])"` — should print `[]`
5. `python3 -c "import json; d=json.load(open('element/config.json')); print(d['embedded_pages'])"` — should print `{'welcome_url': '', 'home_url': ''}`
6. `grep -c "https://" element/config.json` — should return 0
7. `python3 -c "import json; d=json.load(open('well-known/matrix/client')); print(d['m.homeserver']['base_url'])"` — should print `http://__EC2_HOSTNAME__`
8. `python3 -c "import json; d=json.load(open('well-known/matrix/server')); print(d['m.server'])"` — should print `__EC2_HOSTNAME__:80`
9. `python3 -c "import json; json.load(open('element/config.json'))"` — should succeed (valid JSON)
  </verify>
  <done>
Element config.json has base_url and server_name pointing to http://__EC2_HOSTNAME__, permalink_prefix updated, broken example.com links emptied. well-known/matrix/client and server reference the POC hostname with HTTP. No HTTPS URLs remain in any of these files. All files are valid JSON.
  </done>
</task>

</tasks>

<verification>
Combined verification for STACK-02, STACK-03, STACK-04, STACK-05:
1. `grep -c "https://" synapse/homeserver.yaml element/config.json well-known/matrix/client well-known/matrix/server` — all zero
2. `grep "enable_registration: true" synapse/homeserver.yaml` — matches
3. `grep "registration_requires_token: true" synapse/homeserver.yaml` — matches
4. `grep "__EC2_HOSTNAME__" synapse/homeserver.yaml element/config.json well-known/matrix/client well-known/matrix/server` — all files contain the placeholder
5. Consistency check: server_name in homeserver.yaml and config.json both use `__EC2_HOSTNAME__`; base_url in config.json and well-known/client both use `http://__EC2_HOSTNAME__`
</verification>

<success_criteria>
- homeserver.yaml: server_name = __EC2_HOSTNAME__, public_baseurl = http://__EC2_HOSTNAME__/, enable_registration = true, registration_requires_token = true, email block commented out (STACK-02, STACK-03, STACK-05)
- config.json: base_url = http://__EC2_HOSTNAME__, server_name = __EC2_HOSTNAME__, no broken example.com links (STACK-04)
- well-known files: updated to reference __EC2_HOSTNAME__ with HTTP
- All __EC2_HOSTNAME__ placeholders are consistent across files, ready for operator substitution at deploy time
</success_criteria>

<output>
After completion, create `.planning/phases/02-stack-configuration/02-02-SUMMARY.md`
</output>
