---
phase: 03-deploy-and-validate
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: true
requirements: [STACK-06]

must_haves:
  truths:
    - "All four Compose services (postgres, synapse, nginx, element) are running on EC2"
    - "Postgres and synapse show healthy status in docker compose ps"
    - "Nginx and element show running/Up status in docker compose ps (no healthcheck defined — this is expected)"
    - "curl http://<EC2-hostname>/ returns Element Web HTML"
    - "curl http://<EC2-hostname>/_matrix/client/v3/login returns Synapse login flows JSON"
    - "No __EC2_HOSTNAME__ placeholder remains in any config file on EC2"
  artifacts:
    - path: "compose/.env (on EC2)"
      provides: "Filled secrets and real EC2 hostname"
    - path: "synapse_data volume signing.key"
      provides: "Synapse Ed25519 signing key"
  key_links:
    - from: "compose/.env"
      to: "docker-compose.yml"
      via: "environment variable substitution"
    - from: "synapse/homeserver.yaml (post-sed)"
      to: "Synapse container"
      via: "bind mount at /data/homeserver.yaml"
    - from: "element/config.json (post-sed)"
      to: "Element container"
      via: "bind mount at /app/config.json"
---

<objective>
Transfer the repo to EC2, substitute all `__EC2_HOSTNAME__` placeholders with the real hostname, fill `.env` secrets, generate the Synapse signing key, and start the Docker Compose stack.

Purpose: Get all four services (postgres, synapse, nginx, element) running and reachable on EC2 before any user-facing verification.
Output: Running Docker Compose stack accessible at `http://<EC2-hostname>`
</objective>

<execution_context>
@/Users/myownip/.config/claude/get-shit-done/workflows/execute-plan.md
@/Users/myownip/.config/claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-deploy-and-validate/03-RESEARCH.md
@compose/.env.example
@compose/docker-compose.yml
@scripts/aws/provision.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Transfer repo to EC2, substitute placeholders, and fill .env</name>
  <files></files>
  <action>
All commands run from the local machine via SSH/SCP to the EC2 instance.

1. Source instance metadata to get SSH details:
   ```
   source scripts/aws/instance-info.env
   # Provides: PUBLIC_DNS, KEY_FILE, INSTANCE_ID
   ```

2. SCP the entire repo to EC2 (exclude .git, .planning, and the PEM key):
   ```
   scp -i "$KEY_FILE" -o StrictHostKeyChecking=no \
     -r . ec2-user@${PUBLIC_DNS}:~/element-matrix \
     --exclude .git --exclude .planning --exclude '*.pem'
   ```
   Note: `scp -r` does not support `--exclude`. Use rsync instead:
   ```
   rsync -avz -e "ssh -i $KEY_FILE -o StrictHostKeyChecking=no" \
     --exclude '.git' --exclude '.planning' --exclude '*.pem' --exclude 'scripts/aws/instance-info.env' \
     . ec2-user@${PUBLIC_DNS}:~/element-matrix/
   ```

3. SSH into EC2 and run the following steps:

4. Get the EC2 public hostname from IMDS (more reliable than passing it):
   ```
   EC2_HOST=$(curl -s -H "X-aws-ec2-metadata-token: $(curl -s -X PUT http://169.254.169.254/latest/api/token -H 'X-aws-ec2-metadata-token-ttl-seconds: 60')" http://169.254.169.254/latest/meta-data/public-hostname)
   ```

5. Run sed substitution on all four config files (CRITICAL — must happen before any docker compose command):
   ```
   cd ~/element-matrix
   sed -i "s/__EC2_HOSTNAME__/$EC2_HOST/g" \
     synapse/homeserver.yaml \
     element/config.json \
     well-known/matrix/client \
     well-known/matrix/server
   ```

6. Verify NO placeholders remain (this is a blocking gate — do NOT proceed if any match):
   ```
   grep -r "__EC2_HOSTNAME__" synapse/homeserver.yaml element/config.json well-known/matrix/client well-known/matrix/server && echo "FAIL: placeholder still present" && exit 1 || echo "OK: all placeholders replaced"
   ```

7. Create compose/.env from .env.example and fill in all values:
   ```
   cp compose/.env.example compose/.env
   ```
   Then edit compose/.env with these values:
   - `DOMAIN=$EC2_HOST`
   - `ELEMENT_DOMAIN=$EC2_HOST`
   - `MATRIX_DOMAIN=$EC2_HOST`
   - `PUBLIC_BASEURL=http://$EC2_HOST`
   - `SYNAPSE_SERVER_NAME=$EC2_HOST`
   - `SYNAPSE_REPORT_STATS=no`
   - `SYNAPSE_SIGNING_KEY=` (leave empty — signing key is file-based, not env-var-based)
   - `SYNAPSE_ENABLE_REGISTRATION=true`
   - `SYNAPSE_REGISTRATION_REQUIRES_TOKEN=true`
   - Generate secrets with `openssl rand -hex 32` for: `SYNAPSE_REGISTRATION_SHARED_SECRET`, `SYNAPSE_MACAROON_SECRET_KEY`, `SYNAPSE_FORM_SECRET`, `POSTGRES_PASSWORD`
   - `ADMIN_USER=admin`
   - Generate admin password: `ADMIN_PASSWORD=$(openssl rand -hex 16)`
   - Leave SMTP, TURN, BACKUP, CERTBOT values as placeholders (not needed for POC)

   Use sed or a heredoc to write the .env file programmatically. Print the ADMIN_PASSWORD so the user can log in later.

   IMPORTANT: Print the admin username and password clearly to stdout so the human can use them for login verification in Plan 03.
  </action>
  <verify>
SSH into EC2 and run:
```
cd ~/element-matrix
grep "__EC2_HOSTNAME__" synapse/homeserver.yaml element/config.json well-known/matrix/client well-known/matrix/server
# Must return nothing (exit code 1)

grep "POSTGRES_PASSWORD" compose/.env | grep -v "__"
# Must show a real hex string, not a placeholder

grep "PUBLIC_BASEURL" compose/.env
# Must show http://<real-ec2-hostname>
```
  </verify>
  <done>Repo is on EC2, all __EC2_HOSTNAME__ placeholders replaced with real hostname, compose/.env has real secrets and correct hostname values</done>
</task>

<task type="auto">
  <name>Task 2: Generate Synapse signing key and start the Docker Compose stack</name>
  <files></files>
  <action>
All commands run on EC2 via SSH.

1. Generate the Synapse signing key (must happen BEFORE `docker compose up`):
   ```
   cd ~/element-matrix
   docker compose -f compose/docker-compose.yml run --rm \
     -e SYNAPSE_SERVER_NAME="$EC2_HOST" \
     -e SYNAPSE_REPORT_STATS=no \
     synapse generate
   ```

2. Verify the signing key was created. The key may be at `/data/signing.key` or `/data/<server_name>.signing.key`. Check both:
   ```
   docker compose -f compose/docker-compose.yml run --rm synapse ls -la /data/*.key
   ```
   If the key is at `/data/<server_name>.signing.key` but homeserver.yaml references `/data/signing.key`, create a symlink or copy:
   ```
   docker compose -f compose/docker-compose.yml run --rm synapse \
     sh -c 'if [ ! -f /data/signing.key ] && ls /data/*.signing.key 2>/dev/null; then cp /data/*.signing.key /data/signing.key; fi'
   ```

3. Start the stack:
   ```
   docker compose -f compose/docker-compose.yml up -d
   ```

4. Wait for synapse to become healthy (takes 30-60 seconds on first start due to DB migrations):
   ```
   echo "Waiting for synapse to be healthy..."
   for i in $(seq 1 24); do
     STATUS=$(docker compose -f compose/docker-compose.yml ps synapse --format json 2>/dev/null | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('Health','unknown'))" 2>/dev/null || echo "unknown")
     if [ "$STATUS" = "healthy" ]; then
       echo "Synapse is healthy."
       break
     fi
     echo "  attempt $i/24: status=$STATUS — waiting 5s..."
     sleep 5
   done
   ```

5. Check all services are running:
   ```
   docker compose -f compose/docker-compose.yml ps
   ```
   Expected: postgres (healthy), synapse (healthy), element (Up/running), nginx (Up/running). Element and nginx have no healthcheck defined — "Up" is the correct success state for those two.

6. Functional verification:
   ```
   curl -s http://localhost/ | head -20
   # Must return Element Web HTML (look for "Element" or "matrix" in the output)

   curl -s http://localhost/_matrix/client/v3/login | python3 -m json.tool
   # Must return JSON with "flows" array containing m.login.password
   ```
  </action>
  <verify>
```
docker compose -f compose/docker-compose.yml ps
# All 4 services must show Up or healthy

curl -s http://localhost/ | head -5
# Must return HTML (Element Web)

curl -s http://localhost/_matrix/client/v3/login | python3 -c "import sys,json; flows=json.load(sys.stdin)['flows']; print('OK: login flows available' if flows else 'FAIL')"
# Must print "OK: login flows available"
```
  </verify>
  <done>All four Docker Compose services are running. Postgres and synapse show healthy, element and nginx show running. Element Web is served at http://<EC2-hostname>/ and Synapse API responds at /_matrix/client/v3/login.</done>
</task>

</tasks>

<verification>
- `docker compose -f compose/docker-compose.yml ps` shows all 4 services Up (postgres and synapse healthy)
- `curl http://localhost/` returns Element Web HTML
- `curl http://localhost/_matrix/client/v3/login` returns JSON with login flows
- No `__EC2_HOSTNAME__` placeholder found in any config file
- `compose/.env` contains real secrets (no `__CHANGE_ME__` or `__GENERATE_ME__` values in critical fields)
</verification>

<success_criteria>
The Docker Compose stack is fully running on EC2 with all four services operational. Element Web is reachable via HTTP and Synapse API responds to login flow queries. STACK-06 is satisfied.
</success_criteria>

<output>
After completion, create `.planning/phases/03-deploy-and-validate/03-01-SUMMARY.md`
</output>
