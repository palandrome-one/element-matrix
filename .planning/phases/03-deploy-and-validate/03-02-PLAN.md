---
phase: 03-deploy-and-validate
plan: 02
type: execute
wave: 2
depends_on: [03-01]
files_modified: []
autonomous: true
requirements: [VERIFY-01, VERIFY-02, VERIFY-04]

must_haves:
  truths:
    - "Admin user exists in Synapse and can authenticate"
    - "Default Space and 6 rooms exist and are linked to the Space"
    - "A single-use registration token exists for the second test user"
    - "Element Web serves config.json with brand name 'YourBrand Chat' and custom theme"
  artifacts:
    - path: "Synapse database"
      provides: "Admin user @admin:<EC2-hostname>"
    - path: "Synapse database"
      provides: "Space 'YourBrand Community' with 6 child rooms"
    - path: "Registration token"
      provides: "Single-use token for second user registration"
  key_links:
    - from: "bootstrap-admin.sh"
      to: "Synapse register_new_matrix_user"
      via: "docker compose exec"
    - from: "create-default-rooms.py"
      to: "Synapse client API"
      via: "matrix-nio AsyncClient using PUBLIC_BASEURL from .env"
    - from: "Admin access token"
      to: "Registration token API"
      via: "POST /_synapse/admin/v1/registration_tokens/new"
---

<objective>
Create the admin user, set up default rooms/spaces, generate a registration token for the second test user, and verify Element branding.

Purpose: With the stack running (Plan 01), populate it with the admin account, community structure, and prepare for the human E2EE verification in Plan 03.
Output: Admin user exists, rooms visible, registration token printed, branding confirmed via curl.
</objective>

<execution_context>
@/Users/myownip/.config/claude/get-shit-done/workflows/execute-plan.md
@/Users/myownip/.config/claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-deploy-and-validate/03-RESEARCH.md
@.planning/phases/03-deploy-and-validate/03-01-SUMMARY.md
@scripts/bootstrap-admin.sh
@scripts/create-default-rooms.py
@compose/.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Bootstrap admin user and create default rooms</name>
  <files></files>
  <action>
All commands run on EC2 via SSH. Source instance-info.env locally first to get SSH connection details.

1. Run the admin bootstrap script:
   ```
   cd ~/element-matrix
   ./scripts/bootstrap-admin.sh
   ```
   Expected output: "Admin user created successfully."
   Note: The script prints "Login at: https://chat.example.com" — this URL is WRONG for the POC. Ignore it. The correct URL is `http://<EC2-hostname>`.
   If it fails with "User already exists", that is OK — the admin is already created.

2. Install matrix-nio and run the room creation script:
   ```
   which pip3 || sudo dnf install -y python3-pip
   pip3 install matrix-nio --quiet
   python3 scripts/create-default-rooms.py
   ```
   Expected output: "Done! Space and 6 rooms created."

   IMPORTANT: The script reads `PUBLIC_BASEURL` from `compose/.env`. This must be `http://<EC2-hostname>` (set in Plan 01). If the script fails with a connection error, check that PUBLIC_BASEURL is correct and uses `http://` not `https://`.

3. Verify rooms exist by querying the Synapse API. First get an admin access token:
   ```
   ADMIN_USER=$(grep '^ADMIN_USER=' compose/.env | cut -d= -f2)
   ADMIN_PASSWORD=$(grep '^ADMIN_PASSWORD=' compose/.env | cut -d= -f2)

   ACCESS_TOKEN=$(curl -s -X POST \
     "http://localhost:8008/_matrix/client/v3/login" \
     -H "Content-Type: application/json" \
     -d "{\"type\":\"m.login.password\",\"user\":\"$ADMIN_USER\",\"password\":\"$ADMIN_PASSWORD\"}" \
     | python3 -c "import sys,json; print(json.load(sys.stdin)['access_token'])")
   ```

   Then list joined rooms:
   ```
   curl -s "http://localhost:8008/_matrix/client/v3/joined_rooms" \
     -H "Authorization: Bearer $ACCESS_TOKEN" \
     | python3 -m json.tool
   ```
   Must show 7 rooms (1 Space + 6 rooms).
  </action>
  <verify>
```
# Verify admin can authenticate
curl -s -X POST "http://localhost:8008/_matrix/client/v3/login" \
  -H "Content-Type: application/json" \
  -d "{\"type\":\"m.login.password\",\"user\":\"$ADMIN_USER\",\"password\":\"$ADMIN_PASSWORD\"}" \
  | python3 -c "import sys,json; d=json.load(sys.stdin); print('OK: admin login works' if 'access_token' in d else f'FAIL: {d}')"

# Verify rooms exist
curl -s "http://localhost:8008/_matrix/client/v3/joined_rooms" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  | python3 -c "import sys,json; rooms=json.load(sys.stdin)['joined_rooms']; print(f'OK: {len(rooms)} rooms' if len(rooms) >= 7 else f'FAIL: only {len(rooms)} rooms')"
```
  </verify>
  <done>Admin user @admin:<EC2-hostname> exists and can log in. Space "YourBrand Community" and 6 rooms created and linked.</done>
</task>

<task type="auto">
  <name>Task 2: Create registration token and verify Element branding</name>
  <files></files>
  <action>
All commands run on EC2 via SSH. Requires the ACCESS_TOKEN from Task 1.

1. Create a single-use registration token for the second test user:
   ```
   TOKEN_RESPONSE=$(curl -s -X POST \
     "http://localhost:8008/_synapse/admin/v1/registration_tokens/new" \
     -H "Authorization: Bearer $ACCESS_TOKEN" \
     -H "Content-Type: application/json" \
     -d '{"uses_allowed": 1}')

   INVITE_TOKEN=$(echo "$TOKEN_RESPONSE" | python3 -c "import sys,json; print(json.load(sys.stdin)['token'])")
   echo ""
   echo "=========================================="
   echo "  REGISTRATION TOKEN FOR SECOND USER"
   echo "=========================================="
   echo "  Token: $INVITE_TOKEN"
   echo "  URL:   http://$EC2_HOST"
   echo "=========================================="
   ```
   IMPORTANT: Print this token clearly. The human needs it in Plan 03 to register the second user via Element Web.

2. Verify Element branding is served correctly:
   ```
   # Check config.json has correct brand
   curl -s "http://localhost/config.json" | python3 -c "
   import sys,json
   c = json.load(sys.stdin)
   brand = c.get('brand', 'MISSING')
   theme = c.get('default_theme', 'MISSING')
   base_url = c.get('default_server_config', {}).get('m.homeserver', {}).get('base_url', 'MISSING')
   print(f'Brand: {brand}')
   print(f'Theme: {theme}')
   print(f'Homeserver URL: {base_url}')
   assert brand == 'YourBrand Chat', f'Wrong brand: {brand}'
   assert theme == 'custom', f'Wrong theme: {theme}'
   assert base_url.startswith('http://'), f'Wrong base_url: {base_url}'
   print('OK: branding verified')
   "
   ```

3. Check that Element Web HTML loads (basic smoke test for VERIFY-04):
   ```
   curl -s "http://localhost/" | head -10
   # Must contain HTML — Element Web is a React SPA so the HTML is minimal but present
   ```

4. Print a summary for the human with ALL information needed for Plan 03:
   ```
   echo ""
   echo "=========================================="
   echo "  PHASE 3 — VERIFICATION SUMMARY"
   echo "=========================================="
   echo "  Element Web URL: http://$EC2_HOST"
   echo ""
   echo "  Admin login:"
   echo "    Username: $ADMIN_USER"
   echo "    Password: $ADMIN_PASSWORD"
   echo ""
   echo "  Second user registration token: $INVITE_TOKEN"
   echo "  (single-use — enter during Element Web registration)"
   echo "=========================================="
   ```
  </action>
  <verify>
```
# Verify registration token exists
curl -s "http://localhost:8008/_synapse/admin/v1/registration_tokens" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  | python3 -c "import sys,json; tokens=json.load(sys.stdin)['registration_tokens']; print(f'OK: {len(tokens)} token(s)' if tokens else 'FAIL: no tokens')"

# Verify branding
curl -s "http://localhost/config.json" | python3 -c "import sys,json; c=json.load(sys.stdin); print('OK: brand is ' + c['brand'])"
```
  </verify>
  <done>Registration token printed for second user. Element Web config.json confirmed: brand "YourBrand Chat", theme "custom", correct homeserver base_url. Admin credentials and registration token printed clearly for Plan 03 human verification.</done>
</task>

</tasks>

<verification>
- Admin user can authenticate via `m.login.password` endpoint
- At least 7 joined rooms returned from `/joined_rooms` (1 Space + 6 rooms)
- Registration token exists and has `uses_allowed: 1`
- `GET /config.json` returns `brand: "YourBrand Chat"` and `default_theme: "custom"`
- All credentials and tokens printed to stdout for human use in Plan 03
</verification>

<success_criteria>
Admin user is created, default Space and rooms exist, a registration token is available for the second test user, and Element Web branding is confirmed via API. VERIFY-01, VERIFY-02, and VERIFY-04 are programmatically verified. Human visual confirmation deferred to Plan 03.
</success_criteria>

<output>
After completion, create `.planning/phases/03-deploy-and-validate/03-02-SUMMARY.md`
</output>
