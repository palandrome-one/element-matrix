# Pitfalls Research

**Domain:** Matrix/Synapse on AWS EC2 — Docker Compose, no TLS (EC2 public hostname), single instance
**Researched:** 2026-02-20
**Confidence:** MEDIUM-HIGH — Official Synapse docs verified; EC2-specific items cross-referenced via multiple community sources

---

## Critical Pitfalls

### Pitfall 1: `server_name` Set to EC2 Hostname — Permanent and Unrecoverable

**What goes wrong:**
`server_name` in `homeserver.yaml` is baked into every user ID, room ID, and event ever created in the database. If the EC2 instance is replaced or its hostname changes (e.g. elastic IP reassigned, new instance provisioned), and `server_name` was set to the auto-generated EC2 public hostname (`ec2-1-2-3-4.compute-1.amazonaws.com`), the entire database becomes incompatible with the new hostname. Synapse refuses to start with: "Found users in database not native to hostname."

**Why it happens:**
EC2 public DNS hostnames look like valid hostnames. Developers run `docker compose run --rm synapse generate` with `SYNAPSE_SERVER_NAME=ec2-1-2-3-4.compute-1.amazonaws.com` and move on. The error only surfaces when the instance is rebuilt or the IP changes.

**How to avoid:**
For a POC without a custom domain, pick a **stable logical name** that does not depend on the EC2 instance's DNS. Use the EC2 instance's **public IP as `server_name`** (e.g. `1.2.3.4`) or a short placeholder like `demo.internal` that you will consistently reuse. Do not use the auto-assigned EC2 public DNS hostname. Set this before first `docker compose up`; it cannot be changed afterward without dropping the entire database.

**Warning signs:**
- `SYNAPSE_SERVER_NAME` in `docker compose run --rm synapse generate` matches an EC2-generated hostname (contains `compute-1.amazonaws.com` or `ec2-`)
- No explicit `server_name` override in `homeserver.yaml` before first launch

**Phase to address:** EC2 provisioning phase — before any `docker compose up` command runs

**Confidence:** HIGH — Official Synapse docs state: "cannot be changed later"; confirmed by multiple GitHub issues (#3031, #1209)

---

### Pitfall 2: `public_baseurl` Uses HTTPS When Running HTTP-Only

**What goes wrong:**
The default `public_baseurl` generated by Synapse is `https://<server_name>/`. When running without TLS (EC2 public hostname, port 80/8008), the `public_baseurl` in `homeserver.yaml` must use `http://` not `https://`. If the mismatch exists, clients receive misleading errors, password reset links are broken, and Synapse logs no errors at all — making this extremely hard to diagnose.

**Why it happens:**
Developers copy a `homeserver.yaml` template written for a TLS deployment. The `public_baseurl` defaults to HTTPS. The mismatch between `public_baseurl` and the actual listener TLS state is silently accepted by Synapse.

**How to avoid:**
For HTTP-only EC2 deployment: set `public_baseurl: "http://<ec2-public-ip>:8008/"` (or the nginx-proxied URL if nginx is on port 80). Verify by curling `http://<host>/_matrix/client/versions` and confirming the response includes `public_baseurl` matching your configured value.

**Warning signs:**
- Clients show "Invalid homeserver discovery response" or "Your Element is misconfigured"
- Password reset or email verification links in emails contain `https://` but the server is HTTP-only
- `curl http://<host>/_matrix/client/v3/login` works but `curl https://<host>/_matrix/client/v3/login` times out

**Phase to address:** Initial Synapse configuration phase, before first client connection

**Confidence:** HIGH — Confirmed via official config docs and GitHub issue #5346 ("consider rejecting non-https public_baseurl with no tls=false listeners")

---

### Pitfall 3: nginx `proxy_pass` Trailing Slash Breaks Matrix Signature Verification

**What goes wrong:**
Adding a trailing slash to `proxy_pass` in nginx (`proxy_pass http://synapse:8008/;`) causes nginx to canonicalize URI paths. Matrix uses cryptographic signatures over exact request URIs; canonicalization changes the URI and breaks signature verification. The symptom is that invites fail, room joins fail, and Synapse logs "Invalid signature for server" errors. The proxy otherwise appears to work — `/health` checks pass, logins succeed.

**Why it happens:**
Nginx documentation for other services commonly uses a trailing slash. Developers copy-paste from non-Matrix nginx examples without realizing the Matrix protocol's sensitivity to URI modification.

**How to avoid:**
Use `proxy_pass http://synapse:8008;` with no trailing slash, no path suffix. This is explicitly called out in the official Synapse reverse proxy documentation. Apply to every location block that proxies `/_matrix` and `/_synapse/client`.

**Warning signs:**
- `/health` returns 200 but room operations fail
- Synapse logs contain "Invalid signature" or "403 Forbidden" on federation-adjacent operations
- Invites sent between rooms fail even on a single-server (non-federated) deployment

**Phase to address:** nginx configuration phase, verified before any user testing

**Confidence:** HIGH — Explicitly documented in official Synapse reverse proxy docs; confirmed by GitHub issue #3294 ("Reverse proxy causes 'Invalid signature for server'")

---

### Pitfall 4: PostgreSQL Database Created with Wrong Locale/Encoding

**What goes wrong:**
Synapse requires PostgreSQL to be created with `ENCODING=UTF8`, `LC_COLLATE=C`, `LC_CTYPE=C`. If the database is created with any other locale (including the system default on many AWS AMIs, which may be `en_US.UTF-8`), Synapse will fail to store UTF-8 strings correctly and may crash on insert. The error only surfaces once real message data is written — the initial startup and schema migration succeed.

**Why it happens:**
The default `docker compose up` for `postgres:15-alpine` creates the database using `POSTGRES_DB` without locale overrides. The correct encoding requires `POSTGRES_INITDB_ARGS: "--encoding=UTF8 --lc-collate=C --lc-ctype=C"` in the environment.

**How to avoid:**
Set `POSTGRES_INITDB_ARGS: "--encoding=UTF8 --lc-collate=C --lc-ctype=C"` in the postgres service environment in `docker-compose.yml`. Verify after first launch with: `docker compose exec postgres psql -U synapse -c "\l"` — confirm `Collate` and `Ctype` are `C`.

**Warning signs:**
- Missing `POSTGRES_INITDB_ARGS` in `docker-compose.yml` or `.env`
- First message send crashes Synapse with a database encoding error
- `\l` in psql shows `en_US.UTF-8` collation for the synapse database

**Phase to address:** Docker Compose configuration phase, before any data is written

**Confidence:** HIGH — Explicitly required in official Synapse PostgreSQL docs; init args pattern confirmed in multiple deployment guides

---

### Pitfall 5: Synapse Signs Key Not Persisted Across Container Restarts

**What goes wrong:**
If the Synapse signing key (`/data/signing.key`) is not on a persistent volume, every container restart generates a new key. This breaks cross-server verification (even when federation is nominally disabled) and causes "unknown server key" errors if any clients cached the old key. On AWS, this also happens when volumes are accidentally destroyed during instance stop/start or `docker compose down -v`.

**Why it happens:**
The `synapse_data` Docker volume holds the signing key. If `docker compose down -v` is run (removes volumes), or if the volume mount path in `docker-compose.yml` doesn't cover `/data` fully, the key is lost on restart. AWS EBS volumes are tied to the instance — stopping (not terminating) is safe; terminating destroys them unless snapshotted.

**How to avoid:**
Confirm `synapse_data:/data` volume mount covers the signing key path (`/data/signing.key`). Never run `docker compose down -v` in production. On AWS, use EBS volumes and snapshot before any maintenance. Verify key persistence with: `docker compose exec synapse cat /data/signing.key` — same content after restart = correct.

**Warning signs:**
- `signing.key` is not in a named Docker volume
- Instance was terminated and restarted (not stopped/started)
- Synapse logs show "Generating new signing key" at startup after previous initialization

**Phase to address:** Initial Docker Compose volume configuration, verified before demo

**Confidence:** MEDIUM — Inferred from Docker volume behavior and Synapse key generation logic; confirmed by community deployment patterns

---

## Moderate Pitfalls

### Pitfall 6: Element `config.json` Still References `https://` After Moving to HTTP

**What goes wrong:**
The `config.json` `default_server_config.m.homeserver.base_url` field is the URL Element uses to connect to Synapse. If this remains `https://matrix.example.com` while the actual server is HTTP-only on an EC2 hostname, Element will attempt HTTPS, fail, and show "Your Element is misconfigured — Unexpected error resolving homeserver configuration." The app is completely unusable.

**Why it happens:**
`config.json` is a static file mounted into the Element container. It must be manually updated to reflect the EC2 deployment URL. It is easy to overlook when adapting a TLS-based config template.

**How to avoid:**
For HTTP EC2 deployment, set `base_url` to `"http://<ec2-public-ip>:8008"` (or `"http://<ec2-public-ip>"` if nginx proxies on port 80). Verify: open Element in a browser, open DevTools network tab, confirm the first `/_matrix/client/versions` request targets the correct HTTP URL and returns 200.

**Warning signs:**
- Element shows "Your Element is misconfigured" on first load
- Browser DevTools shows failed HTTPS requests to the Matrix API
- `config.json` `base_url` starts with `https://` while nginx has no TLS configured

**Phase to address:** Element configuration step, immediately before first browser test

**Confidence:** HIGH — Confirmed via Element Web documentation and GitHub issue #11154

---

### Pitfall 7: AWS Security Group Missing Port 80 or 8008

**What goes wrong:**
AWS EC2 instances start with only SSH (port 22) open by default. If the security group does not explicitly allow inbound TCP on port 80 (HTTP) and/or 8008 (direct Synapse), the deployment is completely inaccessible. Element Web cannot load, the Matrix API is unreachable. This is infrastructure-level, not application-level — all containers can be healthy while the service is unreachable from the internet.

**Why it happens:**
Developers verify connectivity from within the instance (`curl localhost:8008/health` works) and assume external access works. AWS security groups require explicit allow rules; default-deny is not visible in the application logs.

**How to avoid:**
After provisioning, explicitly add security group rules for:
- TCP 22 (SSH)
- TCP 80 (HTTP — Element and nginx)
- TCP 8008 (Synapse direct, if not behind nginx)
- TCP 443 (if TLS is added later)

Verify externally: `curl http://<ec2-public-ip>/health` from a machine outside the VPC.

**Warning signs:**
- `curl http://localhost:8008/health` works on the instance but `curl http://<ec2-public-ip>:8008/health` times out from a different machine
- AWS console shows only TCP 22 in the inbound security group rules
- No nginx access logs appear when accessing from a browser

**Phase to address:** EC2 provisioning phase, before any application deployment

**Confidence:** HIGH — Standard AWS networking behavior; confirmed by community Matrix deployment guides

---

### Pitfall 8: Docker Compose `depends_on` Without `condition: service_healthy` for Postgres

**What goes wrong:**
Without a healthcheck condition on the `depends_on` relationship, Synapse starts as soon as the PostgreSQL container is *running*, not when PostgreSQL is *ready to accept connections*. Synapse fails to connect, logs a database error, and exits. Docker Compose restarts it. The race condition resolves itself after a few restarts in most cases — but demo environments may start with all services in a crash-loop that takes minutes to stabilize, or may never stabilize on a slow t3.medium cold start.

**Why it happens:**
`depends_on` with only a service name (no `condition`) is the default pattern in most Docker Compose tutorials. The `service_healthy` condition requires an explicit `healthcheck` on the postgres service.

**How to avoid:**
Configure postgres with a `healthcheck` using `pg_isready` and set synapse's `depends_on` to `condition: service_healthy`. This is already correct in the current `docker-compose.yml` — verify it is not removed during any refactoring.

**Warning signs:**
- Synapse exits with "connection refused" to postgres on first startup
- `docker compose ps` shows synapse cycling through Restarting state
- The `depends_on` block uses `- postgres` (shorthand) instead of the `condition: service_healthy` form

**Phase to address:** Docker Compose configuration, verified at first `docker compose up`

**Confidence:** HIGH — Confirmed by official Docker Compose startup order documentation

---

### Pitfall 9: `bind_addresses: ["0.0.0.0"]` Exposes Synapse Directly on All Interfaces

**What goes wrong:**
With `bind_addresses: ["0.0.0.0"]` in `homeserver.yaml` and port 8008 open in the AWS security group, Synapse's internal HTTP port is directly reachable from the internet — bypassing nginx entirely. This exposes the raw Synapse API without rate limiting, security headers, or access controls applied by nginx. Any client can connect directly to port 8008.

**Why it happens:**
`0.0.0.0` is required in Docker networking because `127.0.0.1` prevents Synapse from responding to traffic routed through the Docker bridge network from nginx. Developers leave the AWS security group open on 8008 for debugging and forget to close it.

**How to avoid:**
Keep `bind_addresses: ["0.0.0.0"]` in `homeserver.yaml` (required for Docker networking) but **do not expose port 8008 in the AWS security group**. Port 8008 should only be reachable on the internal Docker network. Nginx should be the only publicly exposed service. Remove port 8008 from the EC2 security group inbound rules entirely — nginx handles all external traffic.

**Warning signs:**
- AWS security group shows TCP 8008 open to `0.0.0.0/0`
- `curl http://<ec2-public-ip>:8008/_matrix/client/versions` returns 200 from outside the VPC
- nginx access logs are empty but Matrix operations succeed (clients found a direct path)

**Phase to address:** EC2 security group hardening, after nginx is confirmed working

**Confidence:** MEDIUM — Standard Docker networking pattern; AWS security group scoping confirmed by AWS docs

---

### Pitfall 10: `enable_registration: false` Blocks Token-Based Registration

**What goes wrong:**
The `registration_requires_token: true` setting only works when `enable_registration: true`. With `enable_registration: false` (the Synapse default), Synapse rejects all registration attempts including token-gated ones. The admin cannot create invite tokens that work. New users receive "Registration has been disabled" even when presenting a valid token.

**Why it happens:**
The Synapse documentation describes `registration_requires_token` as a sub-setting of registration, but `enable_registration: false` is a master switch that overrides it. Developers set both flags believing the combination creates token-only registration, not realizing `false` means no registration at all.

**How to avoid:**
For invite-only (token-gated) registration, set:
```yaml
enable_registration: true
registration_requires_token: true
```
Then create tokens via the admin API: `POST /_synapse/admin/v1/registration_tokens/new`

Verify with: attempt registration without a token — should fail with "No token provided." Attempt with a valid token — should succeed.

**Warning signs:**
- `enable_registration: false` AND `registration_requires_token: true` coexist in `homeserver.yaml`
- Admin token creation API returns tokens but user registration always fails
- Synapse logs show "Registration has been disabled" for token-presenting requests

**Phase to address:** Synapse registration configuration, verified before any invite token testing

**Confidence:** HIGH — Confirmed by official Synapse configuration documentation

---

## Technical Debt Patterns

Shortcuts that seem reasonable but create long-term problems.

| Shortcut | Immediate Benefit | Long-term Cost | When Acceptable |
|----------|-------------------|----------------|-----------------|
| `matrixdotorg/synapse:latest` image tag | Always current | Unexpected breaking changes on restart; POC breaks mid-demo after auto-pull | POC only; pin to specific version (e.g. `v1.120.0`) before demo day |
| SQLite instead of PostgreSQL | Simpler initial setup | Cannot migrate users/rooms to Postgres without full data export-import; no concurrent write support | Never for anything beyond a 1-person test |
| Skipping `POSTGRES_INITDB_ARGS` encoding | Works until first non-ASCII message | Silent corruption or crash on UTF-8 content; requires database rebuild to fix | Never |
| `server_name` set to EC2 hostname | "Works for now" | Permanently tied to that hostname; any EC2 replacement requires full database rebuild | Only if the EC2 instance is treated as permanent infrastructure (not appropriate for POC) |
| `docker compose down -v` to reset state | Clean slate | Destroys all user data, rooms, signing keys, postgres data | Only during initial setup before any real data exists |

---

## Integration Gotchas

Common mistakes when connecting the components in this stack.

| Integration | Common Mistake | Correct Approach |
|-------------|----------------|------------------|
| nginx → Synapse | `proxy_pass http://synapse:8008/;` (trailing slash) | `proxy_pass http://synapse:8008;` — no trailing slash, no path suffix |
| nginx → Synapse | Missing `proxy_http_version 1.1;` | Add it — Synapse uses chunked transfer encoding (HTTP/1.1 feature) |
| nginx → Synapse | `client_max_body_size` not set | Set to match `max_upload_size` in `homeserver.yaml` (50m); nginx default is 1m |
| nginx → Synapse | Missing `x_forwarded: true` in homeserver.yaml listener | Without this, Synapse sees nginx's internal IP as the client; rate limiting and IP banning don't work correctly |
| Element → Synapse | `base_url` in `config.json` uses HTTPS on HTTP deployment | Use `http://` URL matching the actual listener; HTTPS mismatch renders Element unusable |
| Synapse → Postgres | Hostname `postgres` in `homeserver.yaml` not matching Docker Compose service name | Docker networking resolves service names by name; must match exactly |
| Synapse → Postgres | No keepalives configured on unreliable network paths | Add `keepalives`, `keepalives_idle`, `keepalives_interval` to database args if Synapse blocks indefinitely on queries |
| AWS → Docker | Port 8008 open in security group with nginx present | Close port 8008 externally; nginx should be the only externally accessible service |

---

## Performance Traps

Patterns that work at small scale but fail as usage grows.

| Trap | Symptoms | Prevention | When It Breaks |
|------|----------|------------|----------------|
| Default `cp_max: 10` PostgreSQL connections | Synapse queues requests; slow response under load | Adequate for POC/demo; increase for production | At ~50+ concurrent active users |
| No swap space on EC2 t3.medium | OOM killer terminates postgres or synapse under memory pressure; services crash silently | Add 2GB swap file: `fallocate -l 2G /swapfile && chmod 600 /swapfile && mkswap /swapfile && swapon /swapfile` | t3.medium has 4GB RAM; Synapse + Postgres + Docker overhead can approach this at moderate load |
| Media store on root EBS volume | Disk fills up; Synapse errors on media upload; may crash postgres if `/var/lib/docker` fills the same volume | Use separate EBS volume for Docker volumes or monitor disk aggressively; set `max_upload_size` conservatively | At ~5-10GB of uploaded media |
| `url_preview_enabled: false` not set | Synapse fetches external URLs for every posted link; memory and network usage spikes | Verify `url_preview_enabled: false` in `homeserver.yaml` | From first link posted in any room |
| Default room version `"11"` with E2EE default | No performance issue at POC scale, but key backup not configured means user key loss is irreversible | Document that admin must instruct users to export keys; not a scalability issue but a reliability trap | When any user loses their session |

---

## Security Mistakes

Domain-specific security issues for Matrix on HTTP EC2.

| Mistake | Risk | Prevention |
|---------|------|------------|
| Port 8008 open in AWS security group | Direct access to Synapse bypasses nginx rate limiting and security headers | Remove TCP 8008 from inbound security group rules; only ports 80 (and 443 when TLS is added) should be public |
| `enable_registration: true` without `registration_requires_token: true` | Any internet user can create accounts on the server | Always pair `enable_registration: true` with `registration_requires_token: true` for invite-only |
| Placeholder secrets left in `homeserver.yaml` (`__MACAROON_SECRET_KEY__`, etc.) | Anyone who can read the config can forge authentication tokens | Verify all `__PLACEHOLDER__` values are replaced before first `docker compose up`; `grep -r "__" synapse/homeserver.yaml` should return empty |
| `trusted_key_servers: []` with federation accidentally enabled | Server operates without key trust anchors; federation is insecure | Keep `trusted_key_servers: []` and `federation_domain_whitelist: []` for private deployments; if federation is enabled later, add `matrix.org` to trusted key servers |
| Docker socket exposed or privileged containers | Container escape risk | Never mount Docker socket into application containers; no `privileged: true` in Compose |
| HTTP-only deployment (no TLS) on public internet | All credentials, messages, and tokens transmitted in cleartext | Acceptable for POC demo only; add Let's Encrypt before any real user data is entered; document clearly in demo notes |

---

## UX Pitfalls

Common user-experience failures specific to this stack.

| Pitfall | User Impact | Better Approach |
|---------|-------------|-----------------|
| `disable_custom_urls: true` without working default server config | Users cannot connect; no fallback | Verify `default_server_config.m.homeserver.base_url` is correct before enabling `disable_custom_urls` |
| E2EE enabled by default without key backup | Users who lose devices permanently lose message history | Document key export procedure; consider enabling key backup (Secure Backup) in Phase 1 |
| No room pre-created before demo | New users land on empty Element with no rooms visible | Run `create-default-rooms.py` and invite admin user before inviting demo participants |
| No invite token created before demo | Demo participants cannot register | Generate tokens via admin API before the demo; test each token with a test account |
| `embedded_pages.welcome_url` pointing to nonexistent URL | Element shows a broken iframe on first load | Set to empty string or a valid URL; verify the URL resolves before deployment |

---

## "Looks Done But Isn't" Checklist

Things that appear complete but are missing critical pieces.

- [ ] **Synapse running:** Healthcheck passes on `/health` — but verify `/_matrix/client/versions` also returns 200; `/health` passes even with misconfigured database
- [ ] **Element loads:** Browser shows Element UI — but verify it successfully connects to the homeserver by checking the login screen shows your `server_name`, not `matrix.org`
- [ ] **Registration token created:** Token created via admin API — but verify it works by actually registering a test user with it (token creation API succeeds even when `enable_registration: false`)
- [ ] **Postgres running:** Container is healthy — but verify Synapse database was created with correct encoding: `docker compose exec postgres psql -U synapse -c "\l"` shows `C` collation
- [ ] **nginx proxying:** `curl http://<host>/_matrix/client/versions` returns 200 — but verify the request is going through nginx (check nginx access logs), not directly to Synapse on 8008
- [ ] **Well-known files served:** `curl http://<host>/.well-known/matrix/client` returns JSON — but verify it contains the correct `base_url` matching your actual server address
- [ ] **Signing key persisted:** Synapse started successfully — but verify signing key survives a restart: `docker compose restart synapse && docker compose exec synapse cat /data/signing.key` matches the pre-restart key
- [ ] **Secrets substituted:** `homeserver.yaml` loaded — but verify no placeholder values remain: `grep "__" synapse/homeserver.yaml` should return empty

---

## Recovery Strategies

When pitfalls occur despite prevention, how to recover.

| Pitfall | Recovery Cost | Recovery Steps |
|---------|---------------|----------------|
| Wrong `server_name` (EC2 hostname baked in) | HIGH | Drop all volumes (`docker compose down -v`), fix `server_name` in `homeserver.yaml`, re-run `docker compose run --rm synapse generate`, restart stack. All users and rooms lost. |
| Wrong `public_baseurl` | LOW | Edit `homeserver.yaml`, restart synapse (`docker compose restart synapse`). No data loss. |
| nginx trailing slash in `proxy_pass` | LOW | Edit nginx config, reload nginx (`docker compose exec nginx nginx -s reload`). No data loss. |
| Wrong Postgres encoding | HIGH | Export any existing data (likely none in POC), drop and recreate database with correct `POSTGRES_INITDB_ARGS`, run `docker compose down -v postgres` then `docker compose up -d postgres`, let Synapse re-create schema on next startup. |
| `enable_registration: false` blocking tokens | LOW | Edit `homeserver.yaml` (`enable_registration: true`, `registration_requires_token: true`), restart synapse. No data loss. |
| Signing key lost after container rebuild | MEDIUM | Generate new key via `docker compose run --rm synapse generate`. Existing sessions will be invalidated; users must re-verify devices. No message data lost if volumes are intact. |
| Security group blocking port 80 | LOW | Add inbound TCP 80 rule in AWS console. No application restart needed. |
| Element `config.json` wrong `base_url` | LOW | Edit `element/config.json`, restart element container (`docker compose restart element`). No data loss. |

---

## Pitfall-to-Phase Mapping

How roadmap phases should address these pitfalls.

| Pitfall | Prevention Phase | Verification |
|---------|------------------|--------------|
| `server_name` set to EC2 hostname | EC2 Provisioning — before first `docker compose up` | `grep server_name synapse/homeserver.yaml` shows a stable, non-EC2-generated value |
| `public_baseurl` HTTPS/HTTP mismatch | Synapse configuration step | `curl http://<host>/_matrix/client/versions` returns 200; no HTTPS in baseurl when running HTTP |
| nginx `proxy_pass` trailing slash | nginx configuration step | POST a room message and verify it succeeds; check nginx config: `grep proxy_pass proxy/conf.d/element.conf` shows no trailing slash |
| Postgres wrong encoding | Docker Compose setup | `docker compose exec postgres psql -U synapse -c "\l"` shows `C` collation |
| Signing key not persisted | Volume configuration | `docker compose restart synapse` — signing key content unchanged |
| Element `base_url` mismatch | Element configuration step | Element login page shows correct server name; DevTools shows HTTP requests to correct host |
| AWS security group missing ports | EC2 provisioning | `curl http://<ec2-public-ip>/health` succeeds from outside the VPC |
| `depends_on` without healthcheck | Docker Compose configuration | First `docker compose up` starts cleanly without synapse restart loops |
| Port 8008 exposed in security group | EC2 security group hardening | `curl http://<ec2-public-ip>:8008/_matrix/client/versions` times out from external machine |
| `enable_registration` false with token | Registration configuration | Test registration with token succeeds; registration without token fails |
| Placeholder secrets not substituted | Pre-launch checklist | `grep "__" synapse/homeserver.yaml` returns empty |
| No swap space on t3.medium | Instance setup | `free -h` shows swap > 0; `swapon --show` is non-empty |

---

## Sources

- [Synapse Configuration Manual — `server_name`](https://matrix-org.github.io/synapse/latest/usage/configuration/config_documentation.html) — HIGH confidence
- [Synapse Reverse Proxy Documentation](https://matrix-org.github.io/synapse/latest/reverse_proxy.html) — HIGH confidence
- [Synapse PostgreSQL Setup](https://matrix-org.github.io/synapse/latest/postgres.html) — HIGH confidence
- [Synapse Delegation Documentation](https://matrix-org.github.io/synapse/latest/delegate.html) — HIGH confidence
- [GitHub: "Change the name of the server after it's configured" #3031](https://github.com/matrix-org/synapse/issues/3031) — MEDIUM confidence (community issue confirming official limitation)
- [GitHub: "Reverse proxy causes 'Invalid signature for server'" #3294](https://github.com/matrix-org/synapse/issues/3294) — MEDIUM confidence
- [GitHub: "consider rejecting non-https public_baseurl with no tls=false listeners" #5346](https://github.com/matrix-org/synapse/issues/5346) — MEDIUM confidence
- [GitHub: "Element shows fatal misconfigured error" #11154](https://github.com/vector-im/element-web/issues/11154) — MEDIUM confidence
- [Docker Compose Startup Order — official docs](https://docs.docker.com/compose/how-tos/startup-order/) — HIGH confidence
- [Matrix.org — Understanding Synapse Hosting](https://matrix.org/docs/older/understanding-synapse-hosting/) — MEDIUM confidence (marked "older" docs)
- [Element Web config.md](https://github.com/element-hq/element-web/blob/develop/docs/config.md) — HIGH confidence

---
*Pitfalls research for: Matrix/Synapse on AWS EC2 — Docker Compose, HTTP-only POC deployment*
*Researched: 2026-02-20*
