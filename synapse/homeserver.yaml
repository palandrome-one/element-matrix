# Synapse Homeserver Configuration
# Docs: https://element-hq.github.io/synapse/latest/usage/configuration/config_documentation.html
#
# Replace __PLACEHOLDER__ values with real values from your .env
# or use the bootstrap script which performs substitution automatically.

server_name: "example.com"
public_baseurl: "https://matrix.example.com/"
pid_file: /data/homeserver.pid
web_client_location: "https://chat.example.com/"

listeners:
  - port: 8008
    tls: false
    type: http
    x_forwarded: true
    bind_addresses: ["0.0.0.0"]
    resources:
      - names: [client, federation]
        compress: false

# ──────────────────────────────────────────────
# Database
# ──────────────────────────────────────────────
database:
  name: psycopg2
  args:
    user: synapse
    password: "__POSTGRES_PASSWORD__"
    database: synapse
    host: postgres
    port: 5432
    cp_min: 5
    cp_max: 10

# ──────────────────────────────────────────────
# Logging
# ──────────────────────────────────────────────
log_config: "/data/log.config"

# ──────────────────────────────────────────────
# Media
# ──────────────────────────────────────────────
media_store_path: /data/media_store
max_upload_size: 50M
url_preview_enabled: false

# ──────────────────────────────────────────────
# Registration
# ──────────────────────────────────────────────
enable_registration: false
registration_requires_token: true
registration_shared_secret: "__REGISTRATION_SHARED_SECRET__"

# ──────────────────────────────────────────────
# Secrets
# ──────────────────────────────────────────────
macaroon_secret_key: "__MACAROON_SECRET_KEY__"
form_secret: "__FORM_SECRET__"
signing_key_path: "/data/signing.key"

# ──────────────────────────────────────────────
# Federation (OFF by default for private community)
# ──────────────────────────────────────────────
# To enable federation later, remove or comment these lines
# and review docs/security.md for hardening guidance.
federation_domain_whitelist: []
allow_public_rooms_over_federation: false

# ──────────────────────────────────────────────
# Rate Limiting
# ──────────────────────────────────────────────
rc_message:
  per_second: 2
  burst_count: 10

rc_registration:
  per_second: 0.17
  burst_count: 3

rc_login:
  address:
    per_second: 0.17
    burst_count: 3
  account:
    per_second: 0.17
    burst_count: 3

# ──────────────────────────────────────────────
# Room defaults
# ──────────────────────────────────────────────
default_room_version: "11"
encryption_enabled_by_default_for_room_type: "all"

# ──────────────────────────────────────────────
# Retention (optional — uncomment to enable)
# ──────────────────────────────────────────────
# retention:
#   enabled: true
#   default_policy:
#     min_lifetime: 1d
#     max_lifetime: 365d
#   allowed_lifetime_min: 1d
#   allowed_lifetime_max: 365d

# ──────────────────────────────────────────────
# SMTP (email notifications + password reset)
# ──────────────────────────────────────────────
email:
  smtp_host: "__SMTP_HOST__"
  smtp_port: 587
  smtp_user: "__SMTP_USER__"
  smtp_pass: "__SMTP_PASSWORD__"
  require_transport_security: true
  notif_from: "%(app)s <noreply@example.com>"
  app_name: "YourBrand Chat"
  enable_notifs: true
  notif_for_new_users: true

# ──────────────────────────────────────────────
# TURN (Phase 2 — uncomment when coturn is deployed)
# ──────────────────────────────────────────────
# turn_uris:
#   - "turn:turn.example.com:3478?transport=udp"
#   - "turn:turn.example.com:3478?transport=tcp"
#   - "turns:turn.example.com:5349?transport=udp"
#   - "turns:turn.example.com:5349?transport=tcp"
# turn_shared_secret: "__TURN_SECRET__"
# turn_user_lifetime: 86400000
# turn_allow_guests: false

# ──────────────────────────────────────────────
# Trusted key servers (empty = no external trust)
# ──────────────────────────────────────────────
trusted_key_servers: []
suppress_key_server_warning: true

# ──────────────────────────────────────────────
# Metrics (Phase 2 — uncomment for Prometheus)
# ──────────────────────────────────────────────
# enable_metrics: true
# metrics_flags:
#   known_servers: true

# ──────────────────────────────────────────────
# Admin contact + server notices
# ──────────────────────────────────────────────
admin_contact: "mailto:admin@example.com"
server_notices:
  system_mxid_localpart: notices
  system_mxid_display_name: "Server Notices"
  room_name: "Server Notices"
